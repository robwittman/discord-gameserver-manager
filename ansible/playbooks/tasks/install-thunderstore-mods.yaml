---
# Install mods from Thunderstore (Valheim, Risk of Rain 2, etc.)
# Mods are downloaded as .zip files and extracted
#
# Mod ID format: namespace-modname (e.g., "denikson-BepInExPack_Valheim")
# Thunderstore API: https://thunderstore.io/api/docs/

- name: Install Thunderstore mods
  block:
    - name: Create temp directory for mod downloads
      tempfile:
        state: directory
        suffix: _mods
      register: mods_temp

    - name: Download and install enabled mods
      include_tasks: download-thunderstore-mod.yaml
      loop: "{{ enabled_mods }}"
      loop_control:
        loop_var: mod
        label: "{{ mod.name | default(mod.id) }}"

    - name: Clean up temp directory
      file:
        path: "{{ mods_temp.path }}"
        state: absent

  rescue:
    - name: Clean up on failure
      file:
        path: "{{ mods_temp.path }}"
        state: absent
      ignore_errors: yes

    - name: Mod installation encountered errors
      debug:
        msg: "Some mods may have failed to install. Check the logs above for details."
