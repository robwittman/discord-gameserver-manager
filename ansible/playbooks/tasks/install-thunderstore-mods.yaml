---
# Install mods from Thunderstore (Valheim, Risk of Rain 2, etc.)
# Mods are downloaded as .zip files and extracted
#
# Mod ID format: namespace-modname (e.g., "denikson-BepInExPack_Valheim")
# Thunderstore API: https://thunderstore.io/api/docs/

- name: Install Thunderstore mods
  block:
    - name: Create temp directory for mod downloads
      tempfile:
        state: directory
        suffix: _mods
      register: mods_temp

    - name: Download and install enabled mods
      loop: "{{ enabled_mods }}"
      loop_control:
        loop_var: mod
        label: "{{ mod.name | default(mod.id) }}"
      block:
        - name: "Parse mod ID: {{ mod.id }}"
          set_fact:
            mod_parts: "{{ mod.id.split('-') }}"

        - name: "Download mod: {{ mod.name | default(mod.id) }}"
          get_url:
            # Thunderstore download URL format: /package/download/namespace/name/version/
            url: "https://thunderstore.io/package/download/{{ mod_parts[0] }}/{{ mod_parts[1:] | join('-') }}/{{ mod.version | default('latest') }}/"
            dest: "{{ mods_temp.path }}/{{ mod.id }}.zip"
            mode: "0644"
          register: download_result
          ignore_errors: yes

        - name: "Extract mod to plugins directory: {{ mod.id }}"
          when: download_result is success
          unarchive:
            src: "{{ mods_temp.path }}/{{ mod.id }}.zip"
            dest: "{{ mods_dir }}"
            remote_src: yes
            owner: "{{ server_user }}"
            group: "{{ server_user }}"
          ignore_errors: yes

        - name: "Check result for {{ mod.id }}"
          debug:
            msg: "{{ 'Installed' if download_result is success else 'Failed to install' }} {{ mod.id }}"

    - name: Clean up temp directory
      file:
        path: "{{ mods_temp.path }}"
        state: absent

  rescue:
    - name: Clean up on failure
      file:
        path: "{{ mods_temp.path }}"
        state: absent
      ignore_errors: yes

    - name: Mod installation encountered errors
      debug:
        msg: "Some mods may have failed to install. Check the logs above for details."
