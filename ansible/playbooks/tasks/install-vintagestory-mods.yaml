---
# Install mods from Vintage Story Mod DB
# Mods are downloaded as .zip files and placed directly in the Mods folder (not extracted)
#
# Mod ID format: modid (e.g., "carryoncapacity", "creativemod")
# The mod DB API: https://mods.vintagestory.at/

- name: Install Vintage Story mods
  block:
    - name: Get list of currently installed mod files
      find:
        paths: "{{ mods_dir }}"
        patterns: "*.zip"
      register: existing_mods

    - name: Download enabled mods from Vintage Story Mod DB
      loop: "{{ enabled_mods }}"
      loop_control:
        loop_var: mod
        label: "{{ mod.name | default(mod.id) }}"
      block:
        - name: "Download mod: {{ mod.name | default(mod.id) }}"
          get_url:
            url: "https://mods.vintagestory.at/{{ mod.id }}/download/{{ mod.version | default('latest') }}"
            dest: "{{ mods_dir }}/{{ mod.id }}.zip"
            owner: "{{ server_user }}"
            group: "{{ server_user }}"
            mode: "0644"
            force: yes
          register: download_result
          ignore_errors: yes

        - name: "Check download result for {{ mod.id }}"
          debug:
            msg: "{{ 'Downloaded' if download_result is success else 'Failed to download' }} {{ mod.id }}"

    - name: Remove disabled mods
      loop: "{{ mods | selectattr('enabled', 'equalto', false) | list }}"
      loop_control:
        loop_var: mod
        label: "{{ mod.id }}"
      file:
        path: "{{ mods_dir }}/{{ mod.id }}.zip"
        state: absent
      ignore_errors: yes

  rescue:
    - name: Mod installation encountered errors
      debug:
        msg: "Some mods may have failed to install. Check the logs above for details."
