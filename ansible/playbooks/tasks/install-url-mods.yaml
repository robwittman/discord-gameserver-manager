---
# Install mods from direct URLs
# The mod.id field should contain the full URL to download
#
# Supports multiple file formats based on mods_config.fileFormat:
# - zip-keep: Keep as .zip file (e.g., Vintage Story)
# - zip-extract: Extract .zip contents to mods dir
# - dll: Download as .dll (BepInEx plugins)
# - jar: Download as .jar (Minecraft)

- name: Install URL-based mods
  block:
    - name: Create temp directory for mod downloads
      tempfile:
        state: directory
        suffix: _mods
      register: mods_temp
      when: mods_config.fileFormat == 'zip-extract'

    - name: Download and install enabled mods
      include_tasks: download-url-mod.yaml
      loop: "{{ enabled_mods }}"
      loop_control:
        loop_var: mod
        label: "{{ mod.name | default(mod.id) }}"

    - name: Clean up temp directory
      when: mods_temp.path is defined
      file:
        path: "{{ mods_temp.path }}"
        state: absent

  rescue:
    - name: Clean up on failure
      when: mods_temp.path is defined
      file:
        path: "{{ mods_temp.path }}"
        state: absent
      ignore_errors: yes

    - name: Mod installation encountered errors
      debug:
        msg: "Some mods may have failed to install. Check the logs above for details."
